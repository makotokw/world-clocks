<meta charset="utf-8"/>
<style>
body  {
	font-size:0.7em;
	font-style:normal;
	font-family: 'ヒラギノ角ゴ Pro W3', 'Hiragino Kaku Gothic Pro', 'メイリオ', Meiryo, 'ＭＳ Ｐゴシック', "Segoe UI", Verdana, Geneva, Arial, Helvetica, sans-serif;
}
input, select, label {
	font-size:1em;
}
ul#clocks {
	list-style:none; padding:0; margin:0;
	padding-right:2px;
}

li.clock {
	position:relative;
	float:left;
}
li.clock span {
	display:block;
	text-align: center;
	height:1em; line-height:1em;
	margin:2px auto 2px auto;
}
li.clock span.digital_clock {
	margin-top:4px;
}
li.clock input, li.clock select {
	line-height:1em; width:100%;
	margin:0; padding:0;
	border:1px solid #ddd;
	outline:none;
}
li.clock input.dst {
	display:inline; width:auto;
	margin:2px;
}
li.clock .close {
	position:absolute; top:-8px; right:-12px;
	display:none;
}
ul.edit_mode span.digital_clock {
	height:3em; 
}
ul.edit_mode li.clock .close {
	display:inline;
}
#option_button {
	float:right;
}
#option_content {
	margin-top:1em;
	display:none;
	float:right;
}
#skin_select {
	width:6em;
}
#size_range {
	width:90px;	
}
#column_text {
	width:1.5em;
}
#footer {
	clear:both;
}
</style>
<ul id="clocks"></ul>
<div id="footer">
	<img id="option_button" src="images/clock_edit.png"/>
	<div id="option_content">
		<img id="add" src="images/add.png"/>
		<label id="colmun_label">Column:</label>
		<input id="column_text" type="text" pattern="[0-9]+" size="4" required="required" value="3"/>
		<label id="skin_label">Skin:</label>
		<select id="skin_select"></select>
		<label id="size_label">Size:</label>
		<input id="size_range" type="range" step="5" min="30" max="60"/>
	</div>
	<div style="clear:both;"></div>
</div>
<script src="bullseye.js"></script>
<script src="coolclock.js"></script>
<script src="moreskins.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js" type="text/javascript"></script>
<link type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/ui-lightness/jquery-ui.css" rel="stylesheet" />
<script src="jquery.timezonecombobox.js"></script>
<script src="jquery.jeditable.mini.js"></script>
<script>
(function($){
	var w = Blz.Widget;
	//localStorage.clear();
	var timeZones = [{value:"-12.0",label:"(GMT -12:00) Eniwetok, Kwajalein"},
		{value:"-11",label:"(GMT -11:00) Midway Island, Samoa"},
		{value:"-10",label:"(GMT -10:00) Hawaii"},
		{value:"-9",label:"(GMT -9:00) Alaska"},
		{value:"-8",label:"(GMT -8:00) Pacific Time (US &amp; Canada)"},
		{value:"-7",label:"(GMT -7:00) Mountain Time (US &amp; Canada)"},
		{value:"-6",label:"(GMT -6:00) Central Time (US &amp; Canada), Mexico City"},
		{value:"-5",label:"(GMT -5:00) Eastern Time (US &amp; Canada), Bogota, Lima"},
		{value:"-4",label:"(GMT -4:00) Atlantic Time (Canada), Caracas, La Paz"},
		{value:"-3.5",label:"(GMT -3:30) Newfoundland"},
		{value:"-3",label:"(GMT -3:00) Brazil, Buenos Aires, Georgetown"},
		{value:"-2",label:"(GMT -2:00) Mid-Atlantic"},
		{value:"-1",label:"(GMT -1:00 hour) Azores, Cape Verde Islands"},
		{value:"0",label:"(GMT) Western Europe Time, London, Lisbon, Casablanca"},
		{value:"1",label:"(GMT +1:00 hour) Brussels, Copenhagen, Madrid, Paris"},
		{value:"2",label:"(GMT +2:00) Kaliningrad, South Africa"},
		{value:"3",label:"(GMT +3:00) Baghdad, Riyadh, Moscow, St. Petersburg"},
		{value:"3.5",label:"(GMT +3:30) Tehran"},
		{value:"4",label:"(GMT +4:00) Abu Dhabi, Muscat, Baku, Tbilisi"},
		{value:"4.5",label:"(GMT +4:30) Kabul"},
		{value:"5",label:"(GMT +5:00) Ekaterinburg, Islamabad, Karachi, Tashkent"},
		{value:"5.5",label:"(GMT +5:30) Bombay, Calcutta, Madras, New Delhi"},
		{value:"5.75",label:"(GMT +5:45) Kathmandu"},
		{value:"6",label:"(GMT +6:00) Almaty, Dhaka, Colombo"},
		{value:"7",label:"(GMT +7:00) Bangkok, Hanoi, Jakarta"},
		{value:"8",label:"(GMT +8:00) Beijing, Perth, Singapore, Hong Kong"},
		{value:"9",label:"(GMT +9:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk"},
		{value:"9.5",label:"(GMT +9:30) Adelaide, Darwin"},
		{value:"10",label:"(GMT +10:00) Eastern Australia, Guam, Vladivostok"},
		{value:"11",label:"(GMT +11:00) Magadan, Solomon Islands, New Caledonia"},
		{value:"12",label:"(GMT +12:00) Auckland, Wellington, Fiji, Kamchatka"}
	];
	var $timezone = $('<select/>');
	$.each(timeZones,function(i,t){ $timezone.append('<option value="'+t.value+'">'+t.label+'</option>'); });
	
	// localize
	var messages = {
		'size_label':'SIZE_LABEL',
		'skin_label':'SKIN_LABEL',
		'colmun_label':'COLUMN_LABEL',
	};
	$.each(messages,function(key,value){
		$('#' + key).html(w.getResourceString(value));
	});
	
	var radius = w.getPref('radius',40), skin = w.getPref('skin','chunkySwiss'), showSecondHand = true;
	var column = w.getPref('column',4), margin = 5, width = radius*2, listWidth = column*(margin*2 + radius*2);
	var $list = $('#clocks').css({width:listWidth}).disableSelection();
	var localeTime = new Date(), localeOffset = (localeTime.getTimezoneOffset()/(-60.0));
	var locales = {_length:0}, user_locales = w.getPref('locales'), default_locales = [
		{label:w.getResourceString('LOCAL_TIME'),offset:localeOffset, dst:0},
		{label:w.getResourceString('LONDON'),offset:'0', dst:0},
		{label:w.getResourceString('VANCOUVER'),offset:'-8', dst:0},
		//{label:w.getResourceString('SANJOSE'),offset:'-8', dst:0},
		{label:w.getResourceString('TOKYO'), offset:'9', dst:0}
	];
	//$('#clocks').before(user_locales);
	if (user_locales) user_locales = JSON.parse(user_locales);
	if (user_locales && user_locales.length > 0) default_locales = user_locales;

	$.fn.extend({
		editColumn: function() {
			var $edit = $(this).val(column);
			function cancel() {
				$edit.val(column);
			}
			function submit() {
				var c = $edit.val();
				c = parseInt(c);
				if (c > 0 && c <= 10) {
					column = c;
					w.setPref('column',column);
					updateClockSize();
				} else {
					$edit.val(column);
				}
			}
			$edit.keydown(function(e){
				if (e.keyCode == 13) submit();
				else if (e.keyCode == 27) cancel();
			}).blur(function(){submit();});
		},
		editLabel: function(l) {
			var $self = $(this), editing = false;
			$(this).click(function(e){
				if (editing || !$list.hasClass('edit_mode')) return false;
				editing = true;
				var revert = $self.html(), $edit = $('<input type="text" value="' + revert + '"/>');
				$self.empty().append($edit);
				function cancel() {
					$self.html(revert);
					editing = false;
				}
				function submit() {
					l.label = $edit.val();
					$self.html(l.label);
					editing = false;
					saveLocales();
				}
				$edit.keydown(function(e){
					if (e.keyCode == 13) submit();
					else if (e.keyCode == 27) cancel();
				}).blur(function(){submit();}).focus();
			});
		},
		editTimezone:function() {
			var $self = $(this), id = $self.parent().attr('id'), cbxid = id+'_dst', l = locales[id];
			var $select = $timezone.clone();
			var $check = $('<input id="'+cbxid+'" class="dst" type="checkbox"/>').attr('checked',l.dst==1);
			function submit() {
				l.offset = parseFloat($select.val());
				l.dst = $check.attr('checked') ? 1 : 0;
				l.coolClock.setOffset(l.offset + l.dst);
				saveLocales();
			}
			$self.empty().append($select.change(submit).val(l.offset));
			$self.append($check.change(submit)).append('<label for="'+cbxid+'">DST</label>');
		}
	});
	
	$.each(default_locales,function(i,l){newClock(l);});
	updateDigitalClock();
	setInterval(updateDigitalClock,1000);
	
	// edit
	$('#add').attr({title:w.getResourceString('ADD_HELP')}).click(function(){
		var $li = newClock().hide().fadeIn();
		var id = $li.attr('id'), l = locales[id];
		l.editing = true;
		$('.digital_clock',$li).editTimezone();
		saveLocales();
	});
	$('#column_text').editColumn();
	var $skin_select = $('#skin_select'); $.each(CoolClock.config.skins,function(attr){
		$skin_select.append('<option value="'+attr+'">'+attr+'</option>')
	});
	$skin_select.change(function(){
		skin = $(this).val();
		$('li',$list).each(function(i){
			var id = $(this).attr('id'), l = locales[id]
			l.coolClock.setSkin(skin);
		});
		 w.setPref('skin',skin);
	}).val(skin);
	$('#size_range').change(function(){
		changeClockSize($(this).val());
	}).val(radius);
	var $option_content = $('#option_content');
	$('#option_button').attr({title:w.getResourceString('EDIT_HELP')}).toggle(function(){
		$list.addClass('edit_mode').sortable({update:function(){saveLocales();}});
		$option_content.show();
		$('li',$list).each(function(i){
			var id = $(this).attr('id'), l = locales[id];
			l.editing = true;
			$('.digital_clock',$(this)).editTimezone();
		});
	},function(){
		$list.removeClass('edit_mode').sortable('destroy');
		$option_content.hide();
		$('li',$list).each(function(i){
			var id = $(this).attr('id'), l = locales[id];
			l.editing = false;
		});
	});
	
	function saveLocales() {
		var al = [];
		$('li',$list).each(function(i){
			var id = $(this).attr('id'), l = locales[id]
			al.push({label:l.label, offset:l.offset, dst:l.dst});
		});
		w.setPref('locales',JSON.stringify(al));
	}

	function newClock(locale) {
		var i = locales._length++, l = locale || {label:w.getResourceString('LOCAL_TIME'),offset:localeOffset, dst:0};
		var id = 'locale'+i, canvasId = 'clock'+i+'_'+(new Date().valueOf());
		var $li = $('<li/>').attr({id:id}).addClass('clock').css({margin:margin,width:width})
			.html('<img class="close" src="images/close.png"/><span class="label">'+l.label+'</span><canvas id="'+canvasId+'"/><span class="digital_clock"></span>');
		$list.append($li);
		l.coolClock = new CoolClock(canvasId, radius, skin, showSecondHand, parseFloat(l.offset) + l.dst);
		locales[id] = l;
		$('.close').attr({title:w.getResourceString('CLOSE_HELP')}).click(function() {
			$(this).parent().fadeOut('fast', function() {
				$(this).remove();
				saveLocales();
			});
		});
		$('.label', $li).editLabel(l);
		return $li;
	}
	
	function changeClockSize(r) {
		if (!parseInt(r)) return;
		radius = r;
		w.setPref('radius',radius);
		updateClockSize();
	}
	function updateClockSize() {
		var width = radius*2, listWidth = column*(margin*2 + radius*2);
		$list.css({width:listWidth});
		$('li',$list).each(function(i){
			$(this).css({margin:margin,width:width});
			var id = $(this).attr('id');
			locales[id].coolClock.setRadius(radius);
		});
	}
	function toLocalTime() {
		return new Date(this.getUTCFullYear(),this.getUTCMonth(), this.getUTCDate(), this.getUTCHours(), 
			this.getUTCMinutes(), this.getUTCSeconds(), this.getUTCMilliseconds());
	}
	
	function updateDigitalClock() {
		var now = new Date(), days = w.getResourceString('SHORTDAY_NAMES').split(',');
		$('li',$list).each(function(i){
			var id = $(this).attr('id'), l = locales[id]
			if (l.editing) return;
			var t = new Date(now.valueOf() + (l.offset * 1000 * 60 * 60)), lt = toLocalTime.apply(t);
			$(this).find('.digital_clock').html(days[lt.getDay()]+' '+lt.toLocaleTimeString());
		});
	}
})(jQuery);
</script>